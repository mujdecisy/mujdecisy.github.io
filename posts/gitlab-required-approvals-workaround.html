<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Gitlab Required Approvals Count Workaround</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/8435d8a036588007.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8435d8a036588007.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-87b3a303122f2f0d.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-b6ae7f85f00af153.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3893aca8cac41098.js" defer=""></script><script src="/_next/static/chunks/973-5d234989fedc99ce.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-25851c6f18bab8d0.js" defer=""></script><script src="/_next/static/EQ94-hkHSAotxxs3c9XBw/_buildManifest.js" defer=""></script><script src="/_next/static/EQ94-hkHSAotxxs3c9XBw/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css 1m6pqln">.css-1m6pqln{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;}@media (min-width:600px){.css-1m6pqln{padding-left:24px;padding-right:24px;}}@media (min-width:600px){.css-1m6pqln{max-width:600px;}}</style><div class="MuiContainer-root MuiContainer-maxWidthSm css-1m6pqln"><style data-emotion="css 1t18w7m">.css-1t18w7m{margin-top:24px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;}</style><div class="MuiBox-root css-1t18w7m"><style data-emotion="css 11xtqbm">.css-11xtqbm{-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;padding-bottom:5px;}</style><div class="MuiBox-root css-11xtqbm"><style data-emotion="css 1wcfedt">.css-1wcfedt{-webkit-text-decoration:underline;text-decoration:underline;text-decoration-color:rgba(25, 118, 210, 0.4);-webkit-text-decoration:none;text-decoration:none;font-size:larger;font-weight:200;color:black;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.css-1wcfedt:hover{text-decoration-color:inherit;}</style><style data-emotion="css 8boj8s">.css-8boj8s{margin:0;color:#1976d2;-webkit-text-decoration:underline;text-decoration:underline;text-decoration-color:rgba(25, 118, 210, 0.4);-webkit-text-decoration:none;text-decoration:none;font-size:larger;font-weight:200;color:black;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.css-8boj8s:hover{text-decoration-color:inherit;}</style><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways css-8boj8s" href="/"><style data-emotion="css 1m8p3k4">.css-1m8p3k4{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;font-size:1rem;font-weight:300;}</style><p class="MuiTypography-root MuiTypography-body1 css-1m8p3k4">safa yasin</p><style data-emotion="css 13d190d">.css-13d190d{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;font-size:1rem;font-weight:700;margin-left:4px;}</style><p class="MuiTypography-root MuiTypography-body1 css-13d190d">mujdeci</p></a></div><style data-emotion="css 1bvc4cc">.css-1bvc4cc{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;}</style><div class="MuiBox-root css-1bvc4cc"><style data-emotion="css 1wf493t">.css-1wf493t{text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.css-1wf493t:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-1wf493t:hover{background-color:transparent;}}.css-1wf493t.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}</style><style data-emotion="css 1yxmbwk">.css-1yxmbwk{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}.css-1yxmbwk::-moz-focus-inner{border-style:none;}.css-1yxmbwk.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-1yxmbwk{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-1yxmbwk:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-1yxmbwk:hover{background-color:transparent;}}.css-1yxmbwk.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}</style><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeMedium css-1yxmbwk" tabindex="0" aria-label="https://twitter.com/mujdecisy" href="https://twitter.com/mujdecisy" target="_blank"><style data-emotion="css 1k33q06">.css-1k33q06{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="TwitterIcon"><path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"></path></svg></a><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeMedium css-1yxmbwk" tabindex="0" aria-label="https://github.com/mujdecisy" href="https://github.com/mujdecisy" target="_blank"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="GitHubIcon"><path d="M12 1.27a11 11 0 00-3.48 21.46c.55.09.73-.28.73-.55v-1.84c-3.03.64-3.67-1.46-3.67-1.46-.55-1.29-1.28-1.65-1.28-1.65-.92-.65.1-.65.1-.65 1.1 0 1.73 1.1 1.73 1.1.92 1.65 2.57 1.2 3.21.92a2 2 0 01.64-1.47c-2.47-.27-5.04-1.19-5.04-5.5 0-1.1.46-2.1 1.2-2.84a3.76 3.76 0 010-2.93s.91-.28 3.11 1.1c1.8-.49 3.7-.49 5.5 0 2.1-1.38 3.02-1.1 3.02-1.1a3.76 3.76 0 010 2.93c.83.74 1.2 1.74 1.2 2.94 0 4.21-2.57 5.13-5.04 5.4.45.37.82.92.82 2.02v3.03c0 .27.1.64.73.55A11 11 0 0012 1.27"></path></svg></a><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeMedium css-1yxmbwk" tabindex="0" aria-label="https://linkedin.com/in/mujdecisy" href="https://linkedin.com/in/mujdecisy" target="_blank"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkedInIcon"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"></path></svg></a></div></div><style data-emotion="css 39bbo6">.css-39bbo6{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;}</style><hr class="MuiDivider-root MuiDivider-fullWidth css-39bbo6"/><article class="mx-auto max-w-2xl py-16"><h1>Gitlab Required Approvals Count Workaround</h1>
<p>If your side-project with your companions is nominated to be a big project, but not big enough to buy Gitlab/Github enterprise.
Then you will not be able to use some beautiful features of Gitlab/Github like protecting branches with minimum approvals count.
Here is a workaround for your project to achieve this feature over CI/CD steps.
This implementation is done directly on Gitlab, and you can implement same steps on Github too.</p>
<p>Simply you can run some job/workflow when there is a merge request to your protected branch.
It can be anything like running unittests, checks for formatting, deployment on your test servers to prepare that future for QA developers.
And you can set your MR to be possible only within some of these jobs done successfully.
So we can use this feature with the purpose of required approvals for an MR to a protected branch.</p>
<p>However this approach depends on trust in team, because you can simply break this flow by commiting on your job definitions.
Here is the instruction set for the implementation on Gitlab.</p>
<h2>1. Create a Job/Workflow</h2>
<p>This job will be triggered on <code>merge_request_event</code>s to gather some data from Gitlab REST API.
So we need some access token on our project&#x27;s environment variables.</p>
<h3>1.1 Create Your Access Token</h3>
<p>Follow the link below to create a <strong>personal access token</strong>.
Gitlab does not allow <strong>project access tokens</strong> for now to gitlab.com free users,
however in case of being free in the future I left the link below.</p>
<ul>
<li><a href="https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html#create-a-personal-access-token">Personal Access Token Document</a></li>
<li><a href="https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html#create-a-project-access-token">Project Access Token Document</a></li>
</ul>
<p>You must define scopes below for the access token.</p>
<ul>
<li>[x] api</li>
<li>[x] read_user</li>
<li>[x] read_api</li>
<li>[x] read_repository</li>
</ul>
<blockquote>
<p>Do not forget to copy your access token, you will not be able to do it after closing page.</p>
</blockquote>
<h3>1.2 Set Access Token as a Variable</h3>
<p>The one who make this settings must be the owner or maintainer of the project.
Set your copied access token as an environment variable which is named <code>ACCESS_TOKEN</code> and will be a masked variable.</p>
<ul>
<li><a href="https://docs.gitlab.com/ee/ci/variables/#for-a-project">Variable Definition Document</a></li>
</ul>
<p>The variable must be masked because we do not want to reveal our access token on job&#x27;s output.
And other users must have role <code>developer</code>, otherwise they can reveal your access token on settings page.</p>
<h3>1.3 Create an Approval-Check Step on Your CI</h3>
<p>On your <code>.gitlab-ci.yml</code> file add a step called <strong>approval-check</strong> and make this step triggered on <code>merge_request</code> events.
And put it in a proper stage to run.</p>
<pre><code>approval-check:
  stage: sdlc
  only:
    - merge_requests
  script:
    - apt-get -qq update
    - apt-get install -y jq
    - ./.gitlab_approval.sh ${ACCESS_TOKEN} $CI_PROJECT_ID $CI_MERGE_REQUEST_IID
</code></pre>
<p>You should pass required parameters to the bash file.
Since the file will call Gitlab API and evaluate the MR, it needs parameters below:</p>
<ul>
<li><strong>$ACCESS_TOKEN</strong> : to be authorized to Rest calls</li>
<li><strong>$CI_PROJECT_ID</strong> : current project&#x27;s id</li>
<li><strong>$CI_MERGE_REQUEST_IID</strong> : current MR&#x27;s id</li>
</ul>
<p>You will see on the second section, how these parameters are used.
You must define your accesst_token variable on variables section, set a proper stage to your job.</p>
<pre><code>stages:
  - sdlc

...

variables:
  ACCESS_TOKEN: $ACCESS_TOKEN

...

approval-check:
  stage: sdlc
  only:
    - merge_requests
  script:
    - apt-get -qq update
    - apt-get install -y jq
    - ./.gitlab_approval.sh ${ACCESS_TOKEN} $CI_PROJECT_ID $CI_MERGE_REQUEST_IID

</code></pre>
<h2>2. Create Job/Workflow Logic</h2>
<p>Create a bash file and make some Rest requests to gitlab.com to gather info about the MR.
Evaluate approval info for that MR and return error if the approval count is not sufficient.</p>
<h4>1.2 Install JQ</h4>
<p>You must install <a href="https://jqlang.github.io/jq/">jq</a> command line tool for json parsing.
Installation is already added to the <code>approval-check</code> job, and test purposes you can install it like below.</p>
<pre><code>$ apt-get install jq
</code></pre>
<h3>1.3 Create Bash file</h3>
<p>I named it <code>.gitlab-approval.sh</code> and located it in the root of repo folder.
This bash file have 3 parameters as below.</p>
<pre><code># $1 AN_ACCESS_TOKEN with read_api
# $2 CI_PROJECT_ID
# $3 CI_MERGE_REQUEST_IID
</code></pre>
<h3>1.4 Gather Related Authors</h3>
<p>Author of the MR, and other companions that approves current MR are needed.
Thus <a href="https://docs.gitlab.com/ee/api/merge_request_approvals.html#merge-request-level-mr-approvals">Merge Request Level Approvals</a> and <a href="https://docs.gitlab.com/ee/api/merge_requests.html#get-single-mr">Get Single MR</a> endpoints are used.</p>
<pre><code># ----------------------------------- GATHER AUTHOR INFO
resp_author=$(curl --header &quot;Authorization: Bearer ${1}&quot; -s &quot;https://gitlab.com/api/v4/projects/${2}/merge_requests/${3}&quot;)
author=$(echo $resp_author | tr -d &#x27;\n&#x27; | jq -r &#x27;.author.username&#x27;)

# ----------------------------------- GATHER APPROVALS
resp_approvals=$(curl --header &quot;Authorization: Bearer ${1}&quot; -s &quot;https://gitlab.com/api/v4/projects/${2}/merge_requests/${3}/approvals&quot;)
approvals=$(echo $resp_approvals | tr -d &#x27;\n&#x27; | jq -r &#x27;.approved_by&#x27;)

</code></pre>
<h3>1.5 Counting Valid Approvals</h3>
<p>Self-approval is needed to be excluded, and proper approvals should be counted as valid approvals.</p>
<pre><code>total_approval_count=$(echo $approvals | jq length)
valid_approval_count=0
for index in $(seq 0 $(($total_approval_count-1)) )
do
    approval_author=$(echo $approvals | jq -r &quot;.[${index}].user.username&quot;)
    if [ &quot;${author}&quot; != &quot;${approval_author}&quot; ]; then
        ((valid_approval_count++))
    fi
done
</code></pre>
<h3>1.6 Evaluate Valid Approval Count</h3>
<p>If valid_approval_count is less than required_approval_count then script must exit with an error number, like 1.
Otherwise it should exit with 0.</p>
<pre><code>required_approval_count=2

if [ $valid_approval_count -lt $required_approval_count ]; then
    echo &quot;&gt;&gt;&gt;FAILURE&lt;&lt;&lt; At least ${required_approval_count} approvals are needed, from other than the MR author.&quot;
    exit 1
fi
echo &quot;&gt;&gt;&gt;SUCCESS&lt;&lt;&lt; This MR has ${required_approval_count} approvals, from other than the MR author.&quot;
exit 0
</code></pre>
<h2>Conclusion</h2>
<p>With this approach you can simply allow your main branch protected over required approval count for merge requests without paying it.
However it depends on the trust in team, anyone can remove this job directly from <code>.gitlab-ci.yml</code> file and merge the request.
It is not that much strict as Gitlab/Github offers. That&#x27;s why I called this as a workaround for only small teams.</p>
<p>Hope this article will help you with your small projects tend to become a bigger one with multiple development participants.
Have a nice day!</p></article><style data-emotion="css 12u0e5f">.css-12u0e5f{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:24px;}</style><hr class="MuiDivider-root MuiDivider-fullWidth css-12u0e5f"/><style data-emotion="css 1qoq5j">.css-1qoq5j{margin-top:16px;margin-bottom:16px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;font-size:small;color:var(--c2);}</style><div class="MuiBox-root css-1qoq5j">©2023 mujdecisy.</div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Gitlab Required Approvals Count Workaround","date":"2023-11-12","summary":"Even if you are not an Gitlab EE user, you can protect your branches with approval count requirement on your small private projects with your companions.","body":{"raw":"\n# Gitlab Required Approvals Count Workaround\n\nIf your side-project with your companions is nominated to be a big project, but not big enough to buy Gitlab/Github enterprise.\nThen you will not be able to use some beautiful features of Gitlab/Github like protecting branches with minimum approvals count.\nHere is a workaround for your project to achieve this feature over CI/CD steps.\nThis implementation is done directly on Gitlab, and you can implement same steps on Github too.\n\nSimply you can run some job/workflow when there is a merge request to your protected branch.\nIt can be anything like running unittests, checks for formatting, deployment on your test servers to prepare that future for QA developers.\nAnd you can set your MR to be possible only within some of these jobs done successfully.\nSo we can use this feature with the purpose of required approvals for an MR to a protected branch.\n\nHowever this approach depends on trust in team, because you can simply break this flow by commiting on your job definitions.\nHere is the instruction set for the implementation on Gitlab.\n\n## 1. Create a Job/Workflow\nThis job will be triggered on `merge_request_event`s to gather some data from Gitlab REST API.\nSo we need some access token on our project's environment variables.\n\n### 1.1 Create Your Access Token\nFollow the link below to create a **personal access token**.\nGitlab does not allow **project access tokens** for now to gitlab.com free users,\nhowever in case of being free in the future I left the link below.\n\n- [Personal Access Token Document](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html#create-a-personal-access-token)\n- [Project Access Token Document](https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html#create-a-project-access-token)\n\nYou must define scopes below for the access token.\n- [x] api\n- [x] read_user\n- [x] read_api\n- [x] read_repository\n\n\u003e Do not forget to copy your access token, you will not be able to do it after closing page.\n\n### 1.2 Set Access Token as a Variable\nThe one who make this settings must be the owner or maintainer of the project.\nSet your copied access token as an environment variable which is named `ACCESS_TOKEN` and will be a masked variable.\n\n- [Variable Definition Document](https://docs.gitlab.com/ee/ci/variables/#for-a-project)\n\nThe variable must be masked because we do not want to reveal our access token on job's output.\nAnd other users must have role `developer`, otherwise they can reveal your access token on settings page.\n\n\n### 1.3 Create an Approval-Check Step on Your CI\nOn your `.gitlab-ci.yml` file add a step called **approval-check** and make this step triggered on `merge_request` events.\nAnd put it in a proper stage to run.\n```\napproval-check:\n  stage: sdlc\n  only:\n    - merge_requests\n  script:\n    - apt-get -qq update\n    - apt-get install -y jq\n    - ./.gitlab_approval.sh ${ACCESS_TOKEN} $CI_PROJECT_ID $CI_MERGE_REQUEST_IID\n```\nYou should pass required parameters to the bash file.\nSince the file will call Gitlab API and evaluate the MR, it needs parameters below:\n- **$ACCESS_TOKEN** : to be authorized to Rest calls\n- **$CI_PROJECT_ID** : current project's id\n- **$CI_MERGE_REQUEST_IID** : current MR's id\n\nYou will see on the second section, how these parameters are used.\nYou must define your accesst_token variable on variables section, set a proper stage to your job.\n\n```\nstages:\n  - sdlc\n\n...\n\nvariables:\n  ACCESS_TOKEN: $ACCESS_TOKEN\n\n...\n\napproval-check:\n  stage: sdlc\n  only:\n    - merge_requests\n  script:\n    - apt-get -qq update\n    - apt-get install -y jq\n    - ./.gitlab_approval.sh ${ACCESS_TOKEN} $CI_PROJECT_ID $CI_MERGE_REQUEST_IID\n\n```\n\n\n## 2. Create Job/Workflow Logic\nCreate a bash file and make some Rest requests to gitlab.com to gather info about the MR.\nEvaluate approval info for that MR and return error if the approval count is not sufficient.\n\n#### 1.2 Install JQ\nYou must install [jq](https://jqlang.github.io/jq/) command line tool for json parsing.\nInstallation is already added to the `approval-check` job, and test purposes you can install it like below.\n\n```\n$ apt-get install jq\n```\n\n### 1.3 Create Bash file\nI named it `.gitlab-approval.sh` and located it in the root of repo folder.\nThis bash file have 3 parameters as below.\n```\n# $1 AN_ACCESS_TOKEN with read_api\n# $2 CI_PROJECT_ID\n# $3 CI_MERGE_REQUEST_IID\n```\n\n### 1.4 Gather Related Authors\nAuthor of the MR, and other companions that approves current MR are needed.\nThus [Merge Request Level Approvals](https://docs.gitlab.com/ee/api/merge_request_approvals.html#merge-request-level-mr-approvals) and [Get Single MR](https://docs.gitlab.com/ee/api/merge_requests.html#get-single-mr) endpoints are used.\n\n```\n# ----------------------------------- GATHER AUTHOR INFO\nresp_author=$(curl --header \"Authorization: Bearer ${1}\" -s \"https://gitlab.com/api/v4/projects/${2}/merge_requests/${3}\")\nauthor=$(echo $resp_author | tr -d '\\n' | jq -r '.author.username')\n\n# ----------------------------------- GATHER APPROVALS\nresp_approvals=$(curl --header \"Authorization: Bearer ${1}\" -s \"https://gitlab.com/api/v4/projects/${2}/merge_requests/${3}/approvals\")\napprovals=$(echo $resp_approvals | tr -d '\\n' | jq -r '.approved_by')\n\n```\n\n### 1.5 Counting Valid Approvals\nSelf-approval is needed to be excluded, and proper approvals should be counted as valid approvals.\n\n```\ntotal_approval_count=$(echo $approvals | jq length)\nvalid_approval_count=0\nfor index in $(seq 0 $(($total_approval_count-1)) )\ndo\n    approval_author=$(echo $approvals | jq -r \".[${index}].user.username\")\n    if [ \"${author}\" != \"${approval_author}\" ]; then\n        ((valid_approval_count++))\n    fi\ndone\n```\n\n### 1.6 Evaluate Valid Approval Count\nIf valid_approval_count is less than required_approval_count then script must exit with an error number, like 1.\nOtherwise it should exit with 0.\n\n```\nrequired_approval_count=2\n\nif [ $valid_approval_count -lt $required_approval_count ]; then\n    echo \"\u003e\u003e\u003eFAILURE\u003c\u003c\u003c At least ${required_approval_count} approvals are needed, from other than the MR author.\"\n    exit 1\nfi\necho \"\u003e\u003e\u003eSUCCESS\u003c\u003c\u003c This MR has ${required_approval_count} approvals, from other than the MR author.\"\nexit 0\n```\n\n## Conclusion\nWith this approach you can simply allow your main branch protected over required approval count for merge requests without paying it.\nHowever it depends on the trust in team, anyone can remove this job directly from `.gitlab-ci.yml` file and merge the request.\nIt is not that much strict as Gitlab/Github offers. That's why I called this as a workaround for only small teams.\n\nHope this article will help you with your small projects tend to become a bigger one with multiple development participants.\nHave a nice day!","code":"var Component=(()=\u003e{var p=Object.create;var a=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,b=Object.prototype.hasOwnProperty;var v=(r,e)=\u003e()=\u003e(e||r((e={exports:{}}).exports,e),e.exports),_=(r,e)=\u003e{for(var t in e)a(r,t,{get:e[t],enumerable:!0})},l=(r,e,t,i)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let o of u(e))!b.call(r,o)\u0026\u0026o!==t\u0026\u0026a(r,o,{get:()=\u003ee[o],enumerable:!(i=d(e,o))||i.enumerable});return r};var g=(r,e,t)=\u003e(t=r!=null?p(m(r)):{},l(e||!r||!r.__esModule?a(t,\"default\",{value:r,enumerable:!0}):t,r)),f=r=\u003el(a({},\"__esModule\",{value:!0}),r);var c=v((q,s)=\u003e{s.exports=_jsx_runtime});var C={};_(C,{default:()=\u003ek,frontmatter:()=\u003ey});var n=g(c()),y={title:\"Gitlab Required Approvals Count Workaround\",date:new Date(16997472e5),summary:\"Even if you are not an Gitlab EE user, you can protect your branches with approval count requirement on your small private projects with your companions.\"};function h(r){let e=Object.assign({h1:\"h1\",p:\"p\",h2:\"h2\",code:\"code\",h3:\"h3\",strong:\"strong\",ul:\"ul\",li:\"li\",a:\"a\",blockquote:\"blockquote\",pre:\"pre\",h4:\"h4\"},r.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.h1,{children:\"Gitlab Required Approvals Count Workaround\"}),`\n`,(0,n.jsx)(e.p,{children:`If your side-project with your companions is nominated to be a big project, but not big enough to buy Gitlab/Github enterprise.\nThen you will not be able to use some beautiful features of Gitlab/Github like protecting branches with minimum approvals count.\nHere is a workaround for your project to achieve this feature over CI/CD steps.\nThis implementation is done directly on Gitlab, and you can implement same steps on Github too.`}),`\n`,(0,n.jsx)(e.p,{children:`Simply you can run some job/workflow when there is a merge request to your protected branch.\nIt can be anything like running unittests, checks for formatting, deployment on your test servers to prepare that future for QA developers.\nAnd you can set your MR to be possible only within some of these jobs done successfully.\nSo we can use this feature with the purpose of required approvals for an MR to a protected branch.`}),`\n`,(0,n.jsx)(e.p,{children:`However this approach depends on trust in team, because you can simply break this flow by commiting on your job definitions.\nHere is the instruction set for the implementation on Gitlab.`}),`\n`,(0,n.jsx)(e.h2,{children:\"1. Create a Job/Workflow\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"This job will be triggered on \",(0,n.jsx)(e.code,{children:\"merge_request_event\"}),`s to gather some data from Gitlab REST API.\nSo we need some access token on our project's environment variables.`]}),`\n`,(0,n.jsx)(e.h3,{children:\"1.1 Create Your Access Token\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Follow the link below to create a \",(0,n.jsx)(e.strong,{children:\"personal access token\"}),`.\nGitlab does not allow `,(0,n.jsx)(e.strong,{children:\"project access tokens\"}),` for now to gitlab.com free users,\nhowever in case of being free in the future I left the link below.`]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html#create-a-personal-access-token\",children:\"Personal Access Token Document\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html#create-a-project-access-token\",children:\"Project Access Token Document\"})}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"You must define scopes below for the access token.\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"[x] api\"}),`\n`,(0,n.jsx)(e.li,{children:\"[x] read_user\"}),`\n`,(0,n.jsx)(e.li,{children:\"[x] read_api\"}),`\n`,(0,n.jsx)(e.li,{children:\"[x] read_repository\"}),`\n`]}),`\n`,(0,n.jsxs)(e.blockquote,{children:[`\n`,(0,n.jsx)(e.p,{children:\"Do not forget to copy your access token, you will not be able to do it after closing page.\"}),`\n`]}),`\n`,(0,n.jsx)(e.h3,{children:\"1.2 Set Access Token as a Variable\"}),`\n`,(0,n.jsxs)(e.p,{children:[`The one who make this settings must be the owner or maintainer of the project.\nSet your copied access token as an environment variable which is named `,(0,n.jsx)(e.code,{children:\"ACCESS_TOKEN\"}),\" and will be a masked variable.\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://docs.gitlab.com/ee/ci/variables/#for-a-project\",children:\"Variable Definition Document\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[`The variable must be masked because we do not want to reveal our access token on job's output.\nAnd other users must have role `,(0,n.jsx)(e.code,{children:\"developer\"}),\", otherwise they can reveal your access token on settings page.\"]}),`\n`,(0,n.jsx)(e.h3,{children:\"1.3 Create an Approval-Check Step on Your CI\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"On your \",(0,n.jsx)(e.code,{children:\".gitlab-ci.yml\"}),\" file add a step called \",(0,n.jsx)(e.strong,{children:\"approval-check\"}),\" and make this step triggered on \",(0,n.jsx)(e.code,{children:\"merge_request\"}),` events.\nAnd put it in a proper stage to run.`]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`approval-check:\n  stage: sdlc\n  only:\n    - merge_requests\n  script:\n    - apt-get -qq update\n    - apt-get install -y jq\n    - ./.gitlab_approval.sh \\${ACCESS_TOKEN} $CI_PROJECT_ID $CI_MERGE_REQUEST_IID\n`})}),`\n`,(0,n.jsx)(e.p,{children:`You should pass required parameters to the bash file.\nSince the file will call Gitlab API and evaluate the MR, it needs parameters below:`}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"$ACCESS_TOKEN\"}),\" : to be authorized to Rest calls\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"$CI_PROJECT_ID\"}),\" : current project's id\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"$CI_MERGE_REQUEST_IID\"}),\" : current MR's id\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:`You will see on the second section, how these parameters are used.\nYou must define your accesst_token variable on variables section, set a proper stage to your job.`}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`stages:\n  - sdlc\n\n...\n\nvariables:\n  ACCESS_TOKEN: $ACCESS_TOKEN\n\n...\n\napproval-check:\n  stage: sdlc\n  only:\n    - merge_requests\n  script:\n    - apt-get -qq update\n    - apt-get install -y jq\n    - ./.gitlab_approval.sh \\${ACCESS_TOKEN} $CI_PROJECT_ID $CI_MERGE_REQUEST_IID\n\n`})}),`\n`,(0,n.jsx)(e.h2,{children:\"2. Create Job/Workflow Logic\"}),`\n`,(0,n.jsx)(e.p,{children:`Create a bash file and make some Rest requests to gitlab.com to gather info about the MR.\nEvaluate approval info for that MR and return error if the approval count is not sufficient.`}),`\n`,(0,n.jsx)(e.h4,{children:\"1.2 Install JQ\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"You must install \",(0,n.jsx)(e.a,{href:\"https://jqlang.github.io/jq/\",children:\"jq\"}),` command line tool for json parsing.\nInstallation is already added to the `,(0,n.jsx)(e.code,{children:\"approval-check\"}),\" job, and test purposes you can install it like below.\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`$ apt-get install jq\n`})}),`\n`,(0,n.jsx)(e.h3,{children:\"1.3 Create Bash file\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"I named it \",(0,n.jsx)(e.code,{children:\".gitlab-approval.sh\"}),` and located it in the root of repo folder.\nThis bash file have 3 parameters as below.`]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`# $1 AN_ACCESS_TOKEN with read_api\n# $2 CI_PROJECT_ID\n# $3 CI_MERGE_REQUEST_IID\n`})}),`\n`,(0,n.jsx)(e.h3,{children:\"1.4 Gather Related Authors\"}),`\n`,(0,n.jsxs)(e.p,{children:[`Author of the MR, and other companions that approves current MR are needed.\nThus `,(0,n.jsx)(e.a,{href:\"https://docs.gitlab.com/ee/api/merge_request_approvals.html#merge-request-level-mr-approvals\",children:\"Merge Request Level Approvals\"}),\" and \",(0,n.jsx)(e.a,{href:\"https://docs.gitlab.com/ee/api/merge_requests.html#get-single-mr\",children:\"Get Single MR\"}),\" endpoints are used.\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`# ----------------------------------- GATHER AUTHOR INFO\nresp_author=$(curl --header \"Authorization: Bearer \\${1}\" -s \"https://gitlab.com/api/v4/projects/\\${2}/merge_requests/\\${3}\")\nauthor=$(echo $resp_author | tr -d '\\\\n' | jq -r '.author.username')\n\n# ----------------------------------- GATHER APPROVALS\nresp_approvals=$(curl --header \"Authorization: Bearer \\${1}\" -s \"https://gitlab.com/api/v4/projects/\\${2}/merge_requests/\\${3}/approvals\")\napprovals=$(echo $resp_approvals | tr -d '\\\\n' | jq -r '.approved_by')\n\n`})}),`\n`,(0,n.jsx)(e.h3,{children:\"1.5 Counting Valid Approvals\"}),`\n`,(0,n.jsx)(e.p,{children:\"Self-approval is needed to be excluded, and proper approvals should be counted as valid approvals.\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`total_approval_count=$(echo $approvals | jq length)\nvalid_approval_count=0\nfor index in $(seq 0 $(($total_approval_count-1)) )\ndo\n    approval_author=$(echo $approvals | jq -r \".[\\${index}].user.username\")\n    if [ \"\\${author}\" != \"\\${approval_author}\" ]; then\n        ((valid_approval_count++))\n    fi\ndone\n`})}),`\n`,(0,n.jsx)(e.h3,{children:\"1.6 Evaluate Valid Approval Count\"}),`\n`,(0,n.jsx)(e.p,{children:`If valid_approval_count is less than required_approval_count then script must exit with an error number, like 1.\nOtherwise it should exit with 0.`}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`required_approval_count=2\n\nif [ $valid_approval_count -lt $required_approval_count ]; then\n    echo \"\u003e\u003e\u003eFAILURE\u003c\u003c\u003c At least \\${required_approval_count} approvals are needed, from other than the MR author.\"\n    exit 1\nfi\necho \"\u003e\u003e\u003eSUCCESS\u003c\u003c\u003c This MR has \\${required_approval_count} approvals, from other than the MR author.\"\nexit 0\n`})}),`\n`,(0,n.jsx)(e.h2,{children:\"Conclusion\"}),`\n`,(0,n.jsxs)(e.p,{children:[`With this approach you can simply allow your main branch protected over required approval count for merge requests without paying it.\nHowever it depends on the trust in team, anyone can remove this job directly from `,(0,n.jsx)(e.code,{children:\".gitlab-ci.yml\"}),` file and merge the request.\nIt is not that much strict as Gitlab/Github offers. That's why I called this as a workaround for only small teams.`]}),`\n`,(0,n.jsx)(e.p,{children:`Hope this article will help you with your small projects tend to become a bigger one with multiple development participants.\nHave a nice day!`})]})}function w(r={}){let{wrapper:e}=r.components||{};return e?(0,n.jsx)(e,Object.assign({},r,{children:(0,n.jsx)(h,r)})):h(r)}var k=w;return f(C);})();\n;return Component;"},"_id":"gitlab-required-approvals-workaround.mdx","_raw":{"sourceFilePath":"gitlab-required-approvals-workaround.mdx","sourceFileName":"gitlab-required-approvals-workaround.mdx","sourceFileDir":".","contentType":"mdx","flattenedPath":"gitlab-required-approvals-workaround"},"type":"Post","url":"/posts/gitlab-required-approvals-workaround"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"gitlab-required-approvals-workaround"},"buildId":"EQ94-hkHSAotxxs3c9XBw","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>